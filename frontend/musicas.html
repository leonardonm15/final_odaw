<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√∫sicas do √°lbum</title>
  <link rel="stylesheet" href="musicas.css">
</head>
<body>
  <div class="page">

    <header class="header">
      <div class="heading">
        <h1 id="tituloPagina">M√∫sicas do √°lbum</h1>
        <span class="heading-underline"></span>
        <p id="albumSubtitulo" style="margin-top:8px;color:#c7c7c7;font-size:0.9rem;"></p>
      </div>

      <button class="ghost-button" onclick="history.back()">
        Voltar
      </button>
    </header>

    <section class="music-section">
      <h2>Lista de m√∫sicas</h2>

      <p id="emptyState" class="empty-state">
        Nenhuma m√∫sica enviada ainda.
      </p>

      <div id="musicGrid" class="music-grid"></div>
    </section>

    <section class="upload-box">
      <label for="fileInput">Enviar nova m√∫sica para este √°lbum</label>
      <input type="file" id="fileInput" accept="audio/*">
      <button id="uploadButton" class="primary-button" style="margin-top:10px;">
        Fazer upload
      </button>
      <p id="uploadMsg" class="msg" style="margin-top:6px;font-size:0.85rem;color:#ffb3b3;"></p>
    </section>

  </div>

  <script>
    const API_BASE = "http://localhost:8000";

    // L√™ usu√°rio logado (aceita usuarioLogado ou usuariologado)
    function getUsuarioLogado() {
      try {
        const raw =
          localStorage.getItem("usuarioLogado") ||
          localStorage.getItem("usuariologado");

        if (!raw) {
          console.warn("Nenhum usu√°rio logado encontrado no localStorage");
          return null;
        }

        const user = JSON.parse(raw);
        console.log("Usu√°rio logado em musicas.html:", user);
        return user;
      } catch (e) {
        console.error("Erro ao ler usuarioLogado/usuariologado", e);
        return null;
      }
    }

    // Busca info do √°lbum salvo no localStorage (albunsUsuario)
    function getAlbumAtual(id_album, id_usuario) {
      try {
        const raw = localStorage.getItem("albunsUsuario");
        if (!raw) return null;
        const lista = JSON.parse(raw);

        // tenta primeiro bater id_album + id_usuario
        let album = lista.find(
          (a) =>
            String(a.id_album) === String(id_album) &&
            String(a.id_usuario) === String(id_usuario)
        );
        if (album) return album;

        // fallback: qualquer √°lbum com esse id_album (para explorar √°lbuns de outros usu√°rios)
        album = lista.find(
          (a) => String(a.id_album) === String(id_album)
        );
        return album || null;
      } catch (e) {
        console.error("Erro ao ler albunsUsuario", e);
        return null;
      }
    }

    function formatTime(sec) {
      if (!isFinite(sec)) return "--:--";
      const minutes = Math.floor(sec / 60);
      const seconds = Math.floor(sec % 60);
      return `${minutes}:${seconds.toString().padStart(2, "0")}`;
    }

    // devolve a URL do arquivo de √°udio da m√∫sica
    function getMusicUrl(musica) {
      // Se o backend j√° retornar uma URL pronta, use ela:
      if (musica.url_arquivo) return musica.url_arquivo;
      if (musica.url) return musica.url;
      if (musica.caminho) return `${API_BASE}/${musica.caminho}`;

      if (musica.id_musica != null) {
        return `${API_BASE}/musicas/${musica.id_musica}/stream`;
      }
      return null;
    }

    // Renderiza lista de m√∫sicas na tela (com player de √°udio)
    function renderMusicas(musicas) {
      const grid = document.getElementById("musicGrid");
      const empty = document.getElementById("emptyState");

      grid.innerHTML = "";

      if (!musicas || !musicas.length) {
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";

      musicas.forEach((musica) => {
        const card = document.createElement("article");
        card.className = "music-card";

        const nome =
          musica.nome_arquivo ||
          musica.nome ||
          musica.titulo ||
          musica.nome_musica ||
          `M√∫sica #${musica.id_musica || ""}`;

        const url = getMusicUrl(musica);

        card.innerHTML = `
          <div class="music-title">${nome}</div>
          <div class="music-meta">
            G√™nero: ${musica.genero ?? "‚Äî"}
          </div>
          ${
            url
              ? `<div class="player-shell">
                   <button class="play-btn" type="button" aria-label="Tocar">${"‚ñ∂"}</button>
                   <div class="player-body">
                     <div class="time-row">
                       <span class="time current">0:00</span>
                       <span class="time duration">--:--</span>
                     </div>
                     <input class="progress" type="range" min="0" value="0" step="0.01">
                   </div>
                   <audio preload="none" data-src="${url}"></audio>
                 </div>`
              : `<div class="music-meta" style="margin-top:8px;color:#ffb3b3;">
                   (N√£o foi poss√≠vel determinar a URL do √°udio)
                 </div>`
          }
        `;

        grid.appendChild(card);

        // Liga o player customizado (play/pause + preload leve)
        if (url) {
          const playBtn = card.querySelector(".play-btn");
          const audio = card.querySelector("audio");
          const progress = card.querySelector(".progress");
          const currentEl = card.querySelector(".time.current");
          const durationEl = card.querySelector(".time.duration");
          // s√≥ atribui src quando o usu√°rio interagir (evita pr√©-carregar tudo)
          let isLoaded = false;

          playBtn.addEventListener("click", () => {
            // pausa outros √°udios
            document.querySelectorAll(".music-card audio").forEach((other) => {
              if (other !== audio) {
                other.pause();
                other.currentTime = 0;
                const btn = other.closest(".player-shell")?.querySelector(".play-btn");
                if (btn) btn.textContent = "‚ñ∂";
              }
            });

            if (!isLoaded) {
              audio.src = audio.dataset.src;
              isLoaded = true;
            }

            if (audio.paused) {
              audio.play();
              playBtn.textContent = "‚è∏";
            } else {
              audio.pause();
              playBtn.textContent = "‚ñ∂";
            }
          });

          audio.addEventListener("ended", () => {
            playBtn.textContent = "‚ñ∂";
          });

          audio.addEventListener("loadedmetadata", () => {
            durationEl.textContent = formatTime(audio.duration);
            progress.max = audio.duration || 0;
          });

          audio.addEventListener("timeupdate", () => {
            if (!isNaN(audio.currentTime)) {
              progress.value = audio.currentTime;
              currentEl.textContent = formatTime(audio.currentTime);
            }
          });

          progress.addEventListener("input", () => {
            if (!isLoaded) {
              audio.src = audio.dataset.src;
              isLoaded = true;
            }
            audio.currentTime = progress.value;
            currentEl.textContent = formatTime(progress.value);
          });
        }
      });
    }

    // Carrega m√∫sicas do backend e FILTRA por √°lbum
    // se readonly = false, tamb√©m filtra por usu√°rio; se true, ignora usu√°rio
    async function carregarMusicas(id_album, id_usuario, readonly) {
      try {
        const res = await fetch(
          `${API_BASE}/musicas?id_album=${encodeURIComponent(id_album)}`
        );
        if (!res.ok) {
          console.error("Erro ao buscar m√∫sicas:", res.status);
          return;
        }

        const data = await res.json();
        console.log("M√∫sicas recebidas do backend:", data);

        // Garante que temos um array
        let lista = Array.isArray(data) ? data : (data.musicas || []);

        // üî• FILTRO POR √ÅLBUM (sempre) e por USU√ÅRIO somente se n√£o for readonly
        lista = lista.filter((m) => {
          if (m.id_album !== undefined && m.id_album !== null) {
            if (String(m.id_album) !== String(id_album)) return false;
          }
          if (!readonly && m.id_usuario !== undefined && m.id_usuario !== null) {
            if (String(m.id_usuario) !== String(id_usuario)) return false;
          }
          return true;
        });

        console.log("M√∫sicas ap√≥s filtro por √°lbum/usu√°rio:", lista);
        renderMusicas(lista);
      } catch (e) {
        console.error("Erro de conex√£o ao buscar m√∫sicas:", e);
      }
    }

    // Faz upload de uma m√∫sica
    async function uploadMusica(id_album, id_usuario, id_playlist) {
      const fileInput = document.getElementById("fileInput");
      const msg = document.getElementById("uploadMsg");
      msg.style.color = "#ffb3b3";
      msg.textContent = "";

      if (!fileInput.files.length) {
        msg.textContent = "Selecione um arquivo de √°udio primeiro.";
        return;
      }

      const file = fileInput.files[0];

      const nomeInferido = file.name ? file.name.replace(/\.[^/.]+$/, "") : "Nova m√∫sica";
      const formData = new FormData();
      // ‚ö†Ô∏è Se no backend o nome do campo for diferente, troca aqui
      formData.append("nome", nomeInferido);
      formData.append("genero", "Desconhecido");
      formData.append("duracao_seg", 0);
      formData.append("id_album", id_album);
      formData.append("id_usuario", id_usuario);
      if (id_playlist) {
        formData.append("id_playlist", id_playlist);
      }
      formData.append("arquivo", file);

      try {
        const res = await fetch(
          `${API_BASE}/musicas/criar`,
          {
            method: "POST",
            body: formData,
          }
        );

        const data = await res.json();
        console.log("Resposta upload:", data);

        if (!res.ok) {
          msg.textContent = data.detail || "Erro ao enviar m√∫sica.";
          return;
        }

        msg.style.color = "#9ae6b4";
        msg.textContent = "M√∫sica enviada com sucesso!";
        fileInput.value = "";

        // recarrega lista, j√° com filtro
        await carregarMusicas(id_album, id_usuario, false);
      } catch (e) {
        console.error("Erro de conex√£o no upload:", e);
        msg.textContent = "Erro de conex√£o com o servidor.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // 1) garantir login
      const user = getUsuarioLogado();
      if (!user) {
        alert("Voc√™ precisa estar logado para ver as m√∫sicas.");
        window.location.href = "login.html";
        return;
      }

      // 2) pegar params da URL
      const params = new URLSearchParams(window.location.search);
      const id_album = params.get("id_album");
      const readonly = params.get("readonly") === "1"; // üëà modo somente leitura
      const id_playlist = params.get("id_playlist"); // opcional: se quiser j√° vincular a uma playlist

      if (!id_album) {
        document.getElementById("emptyState").textContent =
          "Erro: nenhum √°lbum selecionado (id_album ausente na URL).";
        return;
      }

      // 3) mostrar info do √°lbum
      const album = getAlbumAtual(id_album, user.id_usuario);
      if (album) {
        const tituloPagina = document.getElementById("tituloPagina");
        const subtitulo = document.getElementById("albumSubtitulo");
        tituloPagina.textContent = `M√∫sicas de "${album.titulo}"`;
        subtitulo.textContent = `${album.artista} ¬∑ Ano ${album.ano}`;
      }

      // 4) se readonly, esconde a √°rea de upload
      if (readonly) {
        const uploadBox = document.querySelector(".upload-box");
        if (uploadBox) uploadBox.style.display = "none";
      }

      // 5) carregar m√∫sicas desse √°lbum (com filtro por √°lbum/usu√°rio ou s√≥ por √°lbum)
      carregarMusicas(id_album, user.id_usuario, readonly);

      // 6) ligar bot√£o de upload somente se N√ÉO for readonly
      if (!readonly) {
        const uploadButton = document.getElementById("uploadButton");
        if (uploadButton) {
          uploadButton.addEventListener("click", () =>
            uploadMusica(id_album, user.id_usuario, id_playlist)
          );
        }
      }
    });
  </script>

</body>
</html>
